html_phase4_perfect_split = """
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RetinaGuard | Perfect Split Alignment</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&display=swap');
        
        body { margin: 0; overflow: hidden; background-color: #020205; font-family: 'Rajdhani', sans-serif; user-select: none; }
        
        #canvas-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }

        .hidden-audio { display: none; }

        /* HUD OVERLAY */
        .hud-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%); background-size: 100% 2px;
        }

        /* HEADER & COMMANDER STATS */
        .hud-header {
            position: absolute; top: 0; left: 0; width: 100%; padding: 25px 40px;
            display: flex; justify-content: space-between; align-items: flex-start;
            z-index: 20; pointer-events: none;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
        }
        .brand { font-family: 'Orbitron'; font-weight: 900; font-size: 26px; color: white; letter-spacing: 4px; text-shadow: 0 0 20px rgba(0,243,255,0.5); }
        .brand span { color: #00f3ff; }
        .commander-stats { display: flex; gap: 20px; text-align: right; }
        .stat-box { border: 1px solid rgba(0,243,255,0.3); padding: 5px 15px; background: rgba(0,243,255,0.05); border-radius: 4px; display: flex; flex-direction: column; }
        .stat-box .label { color: #88ccff; font-size: 10px; letter-spacing: 1px; }
        .stat-box .val { color: #00f3ff; font-family: 'Orbitron'; font-size: 14px; font-weight: bold; }

        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }

        /* --- LOBBY --- */
        .lobby-ui {
            position: absolute; width: 100%; top: 55%; left: 0; transform: translateY(-50%);
            display: flex; justify-content: center; gap: 40px; opacity: 0; pointer-events: auto;
        }
        .action-card {
            width: 320px; height: 200px; background: rgba(5, 12, 20, 0.7); border: 1px solid rgba(0,243,255,0.2);
            backdrop-filter: blur(10px); display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; position: relative; overflow: hidden; transition: all 0.2s;
            clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
        }
        .action-card:hover { transform: scale(1.05); background: rgba(5, 12, 20, 0.9); box-shadow: 0 0 50px rgba(0,243,255,0.15); border-color: #00f3ff; }
        .action-card h2 { font-family: 'Orbitron'; font-size: 22px; color: white; margin-top: 15px; letter-spacing: 3px; }
        .action-card p { font-size: 12px; color: #88ccff; letter-spacing: 1px; margin-top: 5px; }
        .card-icon { font-size: 45px; color: #00f3ff; margin-bottom: 5px; filter: drop-shadow(0 0 15px rgba(0,243,255,0.4)); }
        .action-card.secondary:hover { border-color: #ff9900; box-shadow: 0 0 50px rgba(255,150,0,0.15); }
        .action-card.secondary .card-icon { color: #ff9900; filter: drop-shadow(0 0 15px rgba(255,150,0,0.4));}

        /* --- ARMORY LOGS --- */
        .logs-ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transform: scale(0.95); transition: opacity 0.5s; }
        .logs-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; width: 85%; max-width: 1400px; pointer-events: auto; }
        .model-card { background: rgba(10, 15, 20, 0.85); border: 1px solid rgba(255,255,255,0.05); padding: 20px; position: relative; transition: all 0.3s; clip-path: polygon(0 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%); border-left: 3px solid #00f3ff; cursor: pointer; }
        .model-card:hover { transform: translateY(-5px); background: rgba(20, 30, 40, 0.95); border-color: #00f3ff; box-shadow: 0 5px 20px rgba(0,243,255,0.2); }
        .model-card h3 { font-family: 'Orbitron'; color: white; font-size: 16px; margin-bottom: 5px; }
        .model-card p { color: #888; font-size: 11px; margin-top: 10px; }
        .back-btn { position: absolute; bottom: 40px; left: 60px; pointer-events: auto; color: #666; font-family: 'Orbitron'; font-size: 14px; cursor: pointer; transition: all 0.3s; padding: 10px 20px; border: 1px solid transparent; }
        .back-btn:hover { color: white; border-color: rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); }

        /* --- LIVE SCAN PROCESSING (PERFECTLY CENTERED ON RIGHT HALF) --- */
        .processing-ui { 
            position: absolute; 
            top: 50%; 
            left: 75%; /* Dead center of the right half of the screen */
            transform: translate(-50%, -50%); 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none;
        }
        .scan-text { font-family: 'Orbitron'; color: #00f3ff; font-size: 16px; letter-spacing: 6px; margin-bottom: 15px; text-shadow: 0 0 20px #00f3ff; animation: pulseText 1s infinite; text-align: center;}
        
        .live-preview-box {
            width: 400px; height: 300px; border: 1px solid #00f3ff; box-shadow: 0 0 30px rgba(0,243,255,0.2);
            position: relative; overflow: hidden; background: #000; border-radius: 4px;
            clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
        }
        .live-image { width: 100%; height: 100%; object-fit: cover; opacity: 0.6; filter: sepia(1) hue-rotate(180deg) saturate(200%) contrast(150%); } 
        
        .scan-laser {
            position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: #fff; box-shadow: 0 0 20px 5px #00f3ff;
            animation: laserScan 2s linear infinite alternate;
        }
        @keyframes laserScan { 0% { top: 0%; } 100% { top: 100%; } }

        .target-box {
            position: absolute; border: 1px solid #ff0055; width: 50px; height: 50px;
            box-shadow: inset 0 0 10px rgba(255,0,85,0.5); opacity: 0; transform: scale(1.5);
            transition: all 0.2s;
            background: 
                linear-gradient(to right, #ff0055 2px, transparent 2px) 0 0,
                linear-gradient(to right, #ff0055 2px, transparent 2px) 0 100%,
                linear-gradient(to left, #ff0055 2px, transparent 2px) 100% 0,
                linear-gradient(to left, #ff0055 2px, transparent 2px) 100% 100%,
                linear-gradient(to bottom, #ff0055 2px, transparent 2px) 0 0,
                linear-gradient(to bottom, #ff0055 2px, transparent 2px) 100% 0,
                linear-gradient(to top, #ff0055 2px, transparent 2px) 0 100%,
                linear-gradient(to top, #ff0055 2px, transparent 2px) 100% 100%;
            background-repeat: no-repeat; background-size: 10px 10px;
        }

        /* --- RESULTS --- */
        .results-ui { position: absolute; bottom: 5vh; left: 0; width: 100%; display: flex; justify-content: center; gap: 15px; opacity: 0; pointer-events: none; padding: 0 20px; }
        .crate-card {
            pointer-events: auto; width: 140px; height: 190px; background: linear-gradient(180deg, rgba(15,20,30,0.95) 0%, rgba(5,8,10,0.98) 100%);
            border: 1px solid #333; border-top: 2px solid #555; border-radius: 4px; position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: space-between;
            padding: 20px 10px; transition: all 0.2s; transform: translateY(100px); opacity: 0; cursor: pointer;
            clip-path: polygon(10px 0, 100% 0, 100% 100%, 0 100%, 0 10px);
        }
        .crate-card.unlocked { border-top-color: #00f3ff; box-shadow: 0 -5px 25px rgba(0,243,255,0.15); transform: translateY(0); opacity: 1; }
        .crate-card:hover { transform: translateY(-10px) !important; border-color: #00f3ff; z-index: 10; box-shadow: 0 0 30px rgba(0,243,255,0.4); background: rgba(20,30,45,1); }
        .crate-header { font-size: 10px; color: #666; text-transform: uppercase; letter-spacing: 1px; width: 100%; text-align: left; padding-left: 10px;}
        .crate-icon { font-size: 32px; color: #444; transition: color 0.5s; }
        .unlocked .crate-icon { color: #00f3ff; filter: drop-shadow(0 0 8px rgba(0,243,255,0.6)); }
        .crate-label { font-family: 'Orbitron'; font-size: 14px; color: white; letter-spacing: 1px; }
        .status-indicator { font-size: 10px; padding: 6px 10px; border-radius: 2px; background: #222; color: #555; width: 80%; text-align: center; font-weight: bold; }
        .unlocked .status-indicator { background: rgba(0,243,255,0.1); color: #00f3ff; }

        /* --- DETAILS MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-content {
            width: 600px; background: linear-gradient(135deg, #050a10, #0a1520);
            border: 1px solid #00f3ff; box-shadow: 0 0 50px rgba(0,243,255,0.2);
            padding: 40px; border-radius: 8px; position: relative;
            transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            clip-path: polygon(30px 0, 100% 0, 100% calc(100% - 30px), calc(100% - 30px) 100%, 0 100%, 0 30px);
        }
        .modal-close { position: absolute; top: 20px; right: 20px; color: #00f3ff; cursor: pointer; font-size: 20px; transition: 0.2s; }
        .modal-close:hover { color: white; transform: rotate(90deg); }
        .modal-header-text { font-family: 'Orbitron'; font-size: 28px; color: white; letter-spacing: 2px; border-bottom: 1px solid rgba(0,243,255,0.3); padding-bottom: 10px; margin-bottom: 20px;}
        .modal-body { display: flex; gap: 30px; }
        .modal-icon-lg { font-size: 80px; color: #00f3ff; opacity: 0.8; filter: drop-shadow(0 0 20px #00f3ff); }
        .modal-stats { flex: 1; }
        .modal-stat-row { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 5px;}
        .modal-stat-row span:first-child { color: #88ccff; font-size: 12px; text-transform: uppercase;}
        .modal-stat-row span:last-child { color: white; font-family: 'Orbitron'; font-weight: bold;}
        .fake-graph { width: 100%; height: 60px; background: repeating-linear-gradient(90deg, transparent, transparent 10px, rgba(0,243,255,0.1) 10px, rgba(0,243,255,0.1) 20px); margin-top: 20px; border: 1px solid rgba(0,243,255,0.3); position: relative; overflow: hidden;}
        .fake-graph-fill { position: absolute; bottom: 0; left: 0; height: 100%; width: 85%; background: linear-gradient(90deg, rgba(0,243,255,0.2), rgba(0,243,255,0.8)); opacity: 0.5;}

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <audio id="sfx-hover" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3" class="hidden-audio"></audio>
    <audio id="sfx-click" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3" class="hidden-audio"></audio>
    <audio id="sfx-scan" src="https://assets.mixkit.co/active_storage/sfx/2574/2574-preview.mp3" class="hidden-audio" loop></audio>
    <audio id="sfx-success" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3" class="hidden-audio"></audio>
    <audio id="sfx-unlock" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" class="hidden-audio"></audio>

    <div id="canvas-container"></div>
    <div class="hud-overlay"></div>

    <div class="hud-header">
        <div class="brand">RETINA<span>GUARD</span></div>
        <div class="commander-stats">
            <div class="stat-box"><span class="label">SCANS LOGGED</span><span class="val">1,042</span></div>
            <div class="stat-box" style="border-color:rgba(255,150,0,0.3); background:rgba(255,150,0,0.05);"><span class="label" style="color:#ffcc88">ANOMALIES</span><span class="val" style="color:#ff9900">17</span></div>
            <div class="stat-box"><span class="label">SERVER</span><span class="val"><i class="fa-solid fa-signal" style="font-size:10px;"></i> ONLINE</span></div>
        </div>
    </div>

    <div id="ui-layer">
        
        <div class="lobby-ui" id="lobby">
            <div class="action-card btn-hover" onclick="document.getElementById('fileInput').click()">
                <i class="fa-solid fa-cloud-arrow-up card-icon"></i>
                <h2>UPLOAD SCAN</h2>
                <p>INITIALIZE DIAGNOSIS</p>
                <input type="file" id="fileInput" class="hidden" accept="image/*" onchange="handleFileSelect(this)">
            </div>
            <div class="action-card secondary btn-hover" onclick="openLogs()">
                <i class="fa-solid fa-layer-group card-icon"></i>
                <h2>V500 ARMORY</h2>
                <p>VIEW AI MODELS</p>
            </div>
        </div>

        <div class="logs-ui" id="logs">
            <div class="logs-grid">
                <div class="model-card btn-hover"><h3>VESSELS</h3><p>Vascular Analysis. Detects attenuation.</p></div>
                <div class="model-card btn-hover"><h3>MACULA</h3><p>Foveal Targeting. Identifies edema.</p></div>
                <div class="model-card btn-hover"><h3>DRUSEN</h3><p>Deposit Detection. Scans for AMD.</p></div>
                <div class="model-card btn-hover"><h3>NERVES</h3><p>Optic Disc Integrity. Glaucoma indicators.</p></div>
                <div class="model-card btn-hover" style="border-left-color:#ff0055"><h3>BLEEDS</h3><p>Hemorrhage Scan. Detects aneurysms.</p></div>
                <div class="model-card btn-hover"><h3>SCAR</h3><p>Tissue History. Maps laser scars.</p></div>
                <div class="model-card btn-hover" style="grid-column: span 2; border-left-color: #ff9900;"><h3>VERDICT</h3><p>COMMAND NODE. Aggregates all sub-models.</p></div>
            </div>
            <div class="back-btn btn-hover" onclick="closeLogs()"><i class="fa-solid fa-arrow-left"></i> RETURN</div>
        </div>

        <div class="processing-ui" id="processing">
            <div class="scan-text">ANALYZING RETINAL MATRIX</div>
            <div class="live-preview-box" id="preview-box">
                <img id="live-img" class="live-image" src="" alt="Scan">
                <div class="scan-laser"></div>
            </div>
        </div>

        <div class="results-ui" id="results">
             <div class="crate-card btn-hover" onclick="openModal('VESSELS', 'fa-dna', '99.1%', 'NORMAL')"><div class="crate-header">MODEL 01</div><i class="fa-solid fa-dna crate-icon"></i><div class="crate-label">VESSELS</div><div class="status-indicator">LOCKED</div></div>
             <div class="crate-card btn-hover" onclick="openModal('MACULA', 'fa-eye', '99.4%', 'NORMAL')"><div class="crate-header">MODEL 02</div><i class="fa-solid fa-eye crate-icon"></i><div class="crate-label">MACULA</div><div class="status-indicator">LOCKED</div></div>
             <div class="crate-card btn-hover" onclick="openModal('DRUSEN', 'fa-braille', '94.2%', 'NORMAL')"><div class="crate-header">MODEL 03</div><i class="fa-solid fa-braille crate-icon"></i><div class="crate-label">DRUSEN</div><div class="status-indicator">LOCKED</div></div>
             <div class="crate-card btn-hover" onclick="openModal('NERVES', 'fa-wave-square', '97.0%', 'NORMAL')"><div class="crate-header">MODEL 04</div><i class="fa-solid fa-wave-square crate-icon"></i><div class="crate-label">NERVES</div><div class="status-indicator">LOCKED</div></div>
             <div class="crate-card btn-hover" onclick="openModal('BLEEDS', 'fa-droplet', '99.8%', 'ANOMALY DETECTED', '#ff0055')"><div class="crate-header">MODEL 05</div><i class="fa-solid fa-droplet crate-icon"></i><div class="crate-label">BLEEDS</div><div class="status-indicator">LOCKED</div></div>
             <div class="crate-card btn-hover" onclick="openModal('SCAR', 'fa-circle-nodes', '92.5%', 'NORMAL')"><div class="crate-header">MODEL 06</div><i class="fa-solid fa-circle-nodes crate-icon"></i><div class="crate-label">SCAR</div><div class="status-indicator">LOCKED</div></div>
             <div class="crate-card btn-hover" style="border-color:#ff9900" onclick="openModal('VERDICT', 'fa-shield-halved', '99.9%', 'POSITIVE: DIABETIC RETINOPATHY', '#ff9900')"><div class="crate-header">VERDICT</div><i class="fa-solid fa-shield-halved crate-icon" style="color:#ff9900"></i><div class="crate-label" style="color:#ff9900">RESULT</div><div class="status-indicator">PENDING</div></div>
        </div>

    </div>

    <div class="modal-overlay" id="detail-modal">
        <div class="modal-content" id="modal-box">
            <i class="fa-solid fa-xmark modal-close btn-hover" onclick="closeModal()"></i>
            <div class="modal-header-text" id="m-title">MODEL DATA</div>
            <div class="modal-body">
                <i class="fa-solid fa-microchip modal-icon-lg" id="m-icon"></i>
                <div class="modal-stats">
                    <div class="modal-stat-row"><span>Status</span><span id="m-status" style="color:#00ff88">NORMAL</span></div>
                    <div class="modal-stat-row"><span>Confidence</span><span id="m-conf">99.9%</span></div>
                    <div class="modal-stat-row"><span>Processing Time</span><span>12ms</span></div>
                    <div class="modal-stat-row"><span>Sector Scan</span><span>Complete</span></div>
                    <div class="fake-graph"><div class="fake-graph-fill" id="m-graph"></div></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- AUDIO ---
        const sfxHover = document.getElementById('sfx-hover');
        const sfxClick = document.getElementById('sfx-click');
        const sfxScan = document.getElementById('sfx-scan');
        const sfxSuccess = document.getElementById('sfx-success');
        const sfxUnlock = document.getElementById('sfx-unlock');

        document.querySelectorAll('.btn-hover').forEach(el => {
            el.addEventListener('mouseenter', () => { sfxHover.currentTime = 0; sfxHover.play().catch(e=>{}); });
            el.addEventListener('click', () => { sfxClick.currentTime = 0; sfxClick.play().catch(e=>{}); });
        });

        // --- 3D ENGINE ---
        const PARTICLE_COUNT = 20000; 
        let scene, camera, renderer, composer, particles, geometry, material;
        let positions, targetPositions, alphas;
        let visibleCount = 0; let time = 0; let isProcessing = false; 

        init(); animate(); startGenesis();

        function init() {
            scene = new THREE.Scene(); scene.fog = new THREE.FogExp2(0x020205, 0.02);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 30; camera.position.y = 0;
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight); renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('canvas-container').appendChild(renderer.domElement);
            
            const renderScene = new THREE.RenderPass(scene, camera);
            const bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            bloomPass.strength = 0.3; bloomPass.radius = 0.2; bloomPass.threshold = 0.1;
            composer = new THREE.EffectComposer(renderer); composer.addPass(renderScene); composer.addPass(bloomPass);

            geometry = new THREE.BufferGeometry();
            positions = new Float32Array(PARTICLE_COUNT * 3); targetPositions = new Float32Array(PARTICLE_COUNT * 3); alphas = new Float32Array(PARTICLE_COUNT); const sizes = new Float32Array(PARTICLE_COUNT);
            const radius = 9; const tubeWidth = 3.5;
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                positions[i*3] = (Math.random() - 0.5) * 200; positions[i*3+1] = (Math.random() - 0.5) * 200; positions[i*3+2] = (Math.random() - 0.5) * 200;
                const u = Math.random() * Math.PI * 2; const v = (Math.random() * 2 - 1);
                targetPositions[i*3] = (radius + v * tubeWidth * Math.cos(u/2)) * Math.cos(u); targetPositions[i*3+1] = (radius + v * tubeWidth * Math.cos(u/2)) * Math.sin(u); targetPositions[i*3+2] = v * tubeWidth * Math.sin(u/2);
                alphas[i] = 0.0; sizes[i] = Math.random() * 0.8 + 0.2;
            }
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3)); geometry.setAttribute('alpha', new THREE.BufferAttribute(alphas, 1)); geometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));
            material = new THREE.ShaderMaterial({ uniforms: { color: { value: new THREE.Color(0xaaccff) } }, vertexShader: `attribute float alpha; attribute float size; varying float vAlpha; void main() { vAlpha = alpha; vec4 mv = modelViewMatrix * vec4(position, 1.0); gl_PointSize = size * (120.0 / -mv.z); gl_Position = projectionMatrix * mv; }`, fragmentShader: `uniform vec3 color; varying float vAlpha; void main() { float r = distance(gl_PointCoord, vec2(0.5)); if(r > 0.5) discard; gl_FragColor = vec4(color, vAlpha * 0.5); }`, transparent: true, depthWrite: false, blending: THREE.AdditiveBlending });
            particles = new THREE.Points(geometry, material); particles.rotation.z = Math.PI / 6; particles.rotation.x = Math.PI / 4; scene.add(particles);
        }

        // --- SEQUENCE CONTROL ---
        function startGenesis() { alphas[0] = 1.0; geometry.attributes.alpha.needsUpdate = true; visibleCount = 1; setTimeout(multiplyDots, 500); }
        function multiplyDots() {
            if (visibleCount >= PARTICLE_COUNT) { setTimeout(attractToMobius, 500); return; }
            let growth = Math.ceil(visibleCount * 0.3) + 10; let nextLimit = Math.min(visibleCount + growth, PARTICLE_COUNT);
            for (let i = visibleCount; i < nextLimit; i++) alphas[i] = 1.0;
            visibleCount = nextLimit; geometry.attributes.alpha.needsUpdate = true; requestAnimationFrame(multiplyDots);
        }
        function attractToMobius() {
            const startPos = Float32Array.from(geometry.attributes.position.array); const obj = { t: 0 };
            anime({ targets: obj, t: 1, duration: 3000, easing: 'easeInOutExpo', update: () => { const curr = geometry.attributes.position.array; for(let i=0; i<PARTICLE_COUNT; i++) { const idx = i*3; curr[idx] = startPos[idx] + (targetPositions[idx] - startPos[idx]) * obj.t; curr[idx+1] = startPos[idx+1] + (targetPositions[idx+1] - startPos[idx+1]) * obj.t; curr[idx+2] = startPos[idx+2] + (targetPositions[idx+2] - startPos[idx+2]) * obj.t; } geometry.attributes.position.needsUpdate = true; }, complete: () => { revealLobby(); } });
        }
        function revealLobby() { anime({ targets: camera.position, y: -7, z: 28, duration: 2000, easing: 'easeInOutQuad' }); anime({ targets: particles.rotation, x: Math.PI / 3, duration: 2000, easing: 'easeInOutQuad' }); anime({ targets: '.lobby-ui', opacity: [0, 1], translateY: [50, 0], duration: 1000, delay: 200, easing: 'easeOutExpo' }); }
        
        function openLogs() { anime({ targets: '.lobby-ui', opacity: 0, translateY: 50, duration: 500 }); anime({ targets: camera.position, x: -15, y: 0, z: 20, duration: 1500 }); anime({ targets: particles.rotation, y: Math.PI / 2, duration: 1500 }); const logs = document.getElementById('logs'); logs.style.opacity = 1; logs.style.pointerEvents = 'auto'; logs.style.transform = 'scale(1)'; }
        function closeLogs() { const logs = document.getElementById('logs'); logs.style.opacity = 0; logs.style.pointerEvents = 'none'; logs.style.transform = 'scale(0.95)'; anime({ targets: camera.position, x: 0, y: -7, z: 28, duration: 1500 }); anime({ targets: '.lobby-ui', opacity: 1, translateY: 0, duration: 1000, delay: 500 }); }

        // --- PROCESSING & RESULTS ---
        let targetInterval;
        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('live-img').src = e.target.result;
                    startProcessingSequence();
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function startProcessingSequence() {
            sfxScan.play().catch(e=>{});
            anime({ targets: '.lobby-ui', opacity: 0, translateY: -50, duration: 500, easing: 'easeInExpo' });
            
            isProcessing = true;
            
            // FIX: Move camera properly to shift the 3D model beautifully to the left without clipping
            anime({ targets: camera.position, x: 18, y: 0, z: 35, duration: 1500, easing: 'easeInOutQuad' }); 
            anime({ targets: particles.rotation, x: Math.PI/4, z: 0, duration: 1500, easing: 'easeInOutQuad' });

            const processingUI = document.getElementById('processing');
            processingUI.style.opacity = 1;
            
            const previewBox = document.getElementById('preview-box');
            targetInterval = setInterval(() => {
                const box = document.createElement('div');
                box.className = 'target-box';
                box.style.left = Math.random() * 80 + '%'; box.style.top = Math.random() * 80 + '%';
                previewBox.appendChild(box);
                anime({ targets: box, opacity: [0, 1, 0], scale: [1.5, 1, 0.8], duration: 600, easing: 'easeOutSine', complete: () => box.remove() });
            }, 400);

            setTimeout(finishProcessing, 4000);
        }

        function finishProcessing() {
            isProcessing = false;
            clearInterval(targetInterval);
            sfxScan.pause(); sfxScan.currentTime = 0;
            sfxSuccess.play().catch(e=>{});

            anime({ targets: '#processing', opacity: 0, duration: 300 });
            
            // FIX: Return camera strictly to CENTER for the results view
            anime({ targets: camera.position, x: 0, y: -7, z: 30, duration: 1500, easing: 'easeOutExpo' });

            const resultsUI = document.getElementById('results');
            resultsUI.style.opacity = 1; resultsUI.style.pointerEvents = 'auto';

            const crates = document.querySelectorAll('.crate-card');
            crates.forEach((crate, i) => {
                setTimeout(() => {
                    sfxUnlock.currentTime = 0; sfxUnlock.play().catch(e=>{});
                    crate.classList.add('unlocked');
                    const stat = crate.querySelector('.status-indicator');
                    stat.innerText = "NORMAL";
                    if(i === 4) { stat.innerText = "ANOMALY"; stat.style.color = "#ff0055"; } 
                    if(i === 6) { stat.innerText = "POSITIVE"; stat.style.color = "#ff9900"; stat.style.background = "rgba(255,153,0,0.1)"; } 
                }, i * 300);
            });
        }

        function openModal(title, iconClass, conf, status, color = "#00f3ff") {
            sfxClick.play().catch(e=>{});
            const modal = document.getElementById('detail-modal');
            const box = document.getElementById('modal-box');
            document.getElementById('m-title').innerText = title + " REPORT";
            document.getElementById('m-icon').className = `fa-solid ${iconClass} modal-icon-lg`;
            document.getElementById('m-icon').style.color = color;
            document.getElementById('m-icon').style.filter = `drop-shadow(0 0 20px ${color})`;
            document.getElementById('m-conf').innerText = conf;
            document.getElementById('m-status').innerText = status;
            document.getElementById('m-status').style.color = color;
            document.getElementById('m-graph').style.background = `linear-gradient(90deg, rgba(0,0,0,0), ${color})`;
            document.getElementById('m-graph').style.width = conf; 
            modal.style.opacity = 1; modal.style.pointerEvents = 'auto';
            anime({ targets: box, scale: [0.9, 1], opacity: [0, 1], duration: 400, easing: 'easeOutBack' });
        }

        function closeModal() {
            sfxHover.play().catch(e=>{});
            const modal = document.getElementById('detail-modal');
            const box = document.getElementById('modal-box');
            anime({ targets: box, scale: 0.9, opacity: 0, duration: 300, easing: 'easeInBack', complete: () => { modal.style.opacity = 0; modal.style.pointerEvents = 'none'; } });
        }

        function animate() {
            requestAnimationFrame(animate);
            if(particles) { particles.rotation.y += isProcessing ? 0.05 : 0.002; }
            composer.render();
        }
    </script>
</body>
</html>
"""

with open('templates/phase2.html', 'w') as f:
    f.write(html_phase4_perfect_split)