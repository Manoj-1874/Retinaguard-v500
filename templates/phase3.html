html_phase3_armory = """
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RetinaGuard | V500 Armory</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&display=swap');
        
        body { margin: 0; overflow: hidden; background-color: #020205; font-family: 'Rajdhani', sans-serif; }
        
        #canvas-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }

        /* HEADER */
        .hud-header {
            position: absolute; top: 0; left: 0; width: 100%; padding: 30px 50px;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 20; pointer-events: none;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
        }
        .brand { font-family: 'Orbitron'; font-weight: 900; font-size: 26px; color: white; letter-spacing: 4px; text-shadow: 0 0 20px rgba(0,243,255,0.5); }
        .brand span { color: #00f3ff; }
        .server-status { color: #00f3ff; font-size: 12px; letter-spacing: 2px; border: 1px solid rgba(0,243,255,0.3); padding: 8px 20px; background: rgba(0,243,255,0.05); border-radius: 4px; }

        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
        }

        /* --- SCREEN 1: LOBBY --- */
        .lobby-ui {
            position: absolute; width: 100%; top: 55%; left: 0; transform: translateY(-50%);
            display: flex; justify-content: center; gap: 40px; 
            opacity: 0; pointer-events: auto;
        }
        .action-card {
            width: 300px; height: 180px;
            background: rgba(5, 12, 20, 0.8); border: 1px solid rgba(0,243,255,0.2);
            backdrop-filter: blur(10px); border-radius: 8px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; position: relative; overflow: hidden; transition: all 0.3s;
        }
        .action-card:hover { transform: translateY(-5px); border-color: #00f3ff; box-shadow: 0 0 40px rgba(0,243,255,0.2); background: rgba(5, 12, 20, 0.95); }
        .action-card h2 { font-family: 'Orbitron'; font-size: 20px; color: white; margin-top: 15px; letter-spacing: 2px; }
        .action-card p { font-size: 12px; color: #88ccff; letter-spacing: 1px; margin-top: 5px; }
        .card-icon { font-size: 40px; color: #00f3ff; margin-bottom: 5px; filter: drop-shadow(0 0 10px rgba(0,243,255,0.6)); }
        
        .action-card.secondary { border-color: rgba(255,150,0,0.2); }
        .action-card.secondary:hover { border-color: #ff9900; box-shadow: 0 0 40px rgba(255,150,0,0.2); }
        .action-card.secondary .card-icon { color: #ff9900; }

        /* --- SCREEN 2: LOGS (THE ARMORY) --- */
        .logs-ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transform: scale(0.95); transition: opacity 0.5s;
        }
        .logs-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;
            width: 80%; max-width: 1200px; pointer-events: auto;
        }
        .model-card {
            background: rgba(10, 15, 20, 0.9); border: 1px solid #333;
            border-left: 3px solid #00f3ff;
            padding: 20px; border-radius: 4px; position: relative;
            transition: all 0.3s; cursor: default;
        }
        .model-card:hover { transform: translateX(10px); background: rgba(20, 30, 40, 0.95); border-color: #00f3ff; box-shadow: 0 0 20px rgba(0,243,255,0.1); }
        .model-card h3 { font-family: 'Orbitron'; color: white; font-size: 16px; margin-bottom: 5px; }
        .model-card .role { color: #00f3ff; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
        .model-card p { color: #888; font-size: 11px; line-height: 1.4; }
        .stat-bar { width: 100%; height: 3px; background: #222; margin-top: 15px; border-radius: 2px; overflow: hidden; }
        .stat-fill { height: 100%; background: #00f3ff; width: 0%; transition: width 1s ease-out; }
        
        .back-btn {
            position: absolute; bottom: 50px; left: 50px; pointer-events: auto;
            color: #555; font-family: 'Orbitron'; font-size: 14px; cursor: pointer;
            transition: all 0.3s; display: flex; align-items: center; gap: 10px;
        }
        .back-btn:hover { color: white; text-shadow: 0 0 10px white; }

        /* --- SCREEN 3: PROCESSING --- */
        .processing-ui {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; opacity: 0; pointer-events: none; width: 500px;
        }
        .scan-text { font-family: 'Orbitron'; color: #00f3ff; font-size: 16px; letter-spacing: 6px; margin-bottom: 20px; text-shadow: 0 0 20px #00f3ff; animation: pulseText 2s infinite; }
        @keyframes pulseText { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .progress-track { width: 100%; height: 2px; background: rgba(255,255,255,0.1); position: relative; }
        .progress-bar { width: 0%; height: 100%; background: #00f3ff; box-shadow: 0 0 20px #00f3ff; position: absolute; top: 0; left: 0; }

        /* --- SCREEN 4: RESULTS --- */
        .results-ui {
            position: absolute; bottom: 8vh; left: 0; width: 100%;
            display: flex; justify-content: center; gap: 20px;
            opacity: 0; pointer-events: none; padding: 0 40px;
        }
        .crate-card {
            pointer-events: auto; width: 150px; height: 200px;
            background: linear-gradient(180deg, rgba(15,20,30,0.95) 0%, rgba(5,8,10,0.98) 100%);
            border: 1px solid #333; border-top: 2px solid #555;
            border-radius: 6px; position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: space-between;
            padding: 20px 10px; transition: all 0.3s;
            transform: translateY(100px); opacity: 0;
        }
        .crate-card.unlocked { border-top-color: #00f3ff; box-shadow: 0 -5px 25px rgba(0,243,255,0.15); transform: translateY(0); opacity: 1; }
        .crate-card:hover { transform: translateY(-15px) !important; border-color: #00f3ff; z-index: 10; box-shadow: 0 0 30px rgba(0,243,255,0.2); }
        .crate-header { font-size: 10px; color: #666; text-transform: uppercase; letter-spacing: 1px; width: 100%; text-align: left; padding-left: 10px;}
        .crate-icon { font-size: 32px; color: #444; transition: color 0.5s; }
        .unlocked .crate-icon { color: #00f3ff; filter: drop-shadow(0 0 8px rgba(0,243,255,0.6)); }
        .crate-label { font-family: 'Orbitron'; font-size: 14px; color: white; letter-spacing: 1px; }
        .status-indicator { font-size: 10px; padding: 6px 10px; border-radius: 2px; background: #222; color: #555; width: 80%; text-align: center; font-weight: bold; }
        .unlocked .status-indicator { background: rgba(0,243,255,0.1); color: #00f3ff; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="canvas-container"></div>

    <div class="hud-header">
        <div class="brand">RETINA<span>GUARD</span></div>
        <div class="server-status"><i class="fa-solid fa-signal"></i> SYSTEM ONLINE</div>
    </div>

    <div id="ui-layer">
        
        <div class="lobby-ui" id="lobby">
            <div class="action-card" onclick="document.getElementById('fileInput').click()">
                <i class="fa-solid fa-cloud-arrow-up card-icon"></i>
                <h2>UPLOAD SCAN</h2>
                <p>INITIALIZE DIAGNOSIS</p>
                <input type="file" id="fileInput" class="hidden" accept="image/*" onchange="handleFileSelect(this)">
            </div>
            <div class="action-card secondary" onclick="openLogs()">
                <i class="fa-solid fa-database card-icon"></i>
                <h2>V500 LOGS</h2>
                <p>VIEW AI MODELS</p>
            </div>
        </div>

        <div class="logs-ui" id="logs">
            <div class="logs-grid">
                <div class="model-card">
                    <h3>VESSELS</h3>
                    <div class="role">Vascular Analysis</div>
                    <p>Detects attenuation, tortuosity, and nicking in retinal vasculature.</p>
                    <div class="stat-bar"><div class="stat-fill" style="width: 98%"></div></div>
                </div>
                <div class="model-card">
                    <h3>MACULA</h3>
                    <div class="role">Foveal Targeting</div>
                    <p>Identifies edema and degeneration in the central vision zone.</p>
                    <div class="stat-bar"><div class="stat-fill" style="width: 99%"></div></div>
                </div>
                <div class="model-card">
                    <h3>DRUSEN</h3>
                    <div class="role">Deposit Detection</div>
                    <p>Scans for extracellular material indicating early AMD.</p>
                    <div class="stat-bar"><div class="stat-fill" style="width: 94%"></div></div>
                </div>
                 <div class="model-card">
                    <h3>NERVES</h3>
                    <div class="role">Optic Disc Integrity</div>
                    <p>Analyzes cup-to-disc ratio for glaucoma indicators.</p>
                    <div class="stat-bar"><div class="stat-fill" style="width: 97%"></div></div>
                </div>
                 <div class="model-card">
                    <h3>BLEEDS</h3>
                    <div class="role">Hemorrhage Scan</div>
                    <p>Detects micro-aneurysms and active bleeding sites.</p>
                    <div class="stat-bar"><div class="stat-fill" style="width: 96%"></div></div>
                </div>
                 <div class="model-card">
                    <h3>SCAR</h3>
                    <div class="role">Tissue History</div>
                    <p>Maps laser scars and photocoagulation marks.</p>
                    <div class="stat-bar"><div class="stat-fill" style="width: 92%"></div></div>
                </div>
                 <div class="model-card" style="grid-column: span 2; border-color: #ff9900;">
                    <h3 style="color:#ff9900">VERDICT</h3>
                    <div class="role" style="color:#ffcc88">COMMAND NODE</div>
                    <p>Aggregates all 6 sub-models to produce final diagnosis.</p>
                    <div class="stat-bar" style="background:#332200"><div class="stat-fill" style="width: 100%; background:#ff9900"></div></div>
                </div>
            </div>

            <div class="back-btn" onclick="closeLogs()">
                <i class="fa-solid fa-arrow-left"></i> RETURN TO LOBBY
            </div>
        </div>

        <div class="processing-ui" id="processing">
            <div class="scan-text">DECRYPTING RETINAL MATRIX...</div>
            <div class="progress-track"><div class="progress-bar" id="load-bar"></div></div>
        </div>

        <div class="results-ui" id="results">
            <div class="crate-card" id="c1"><div class="crate-header">MODEL 01</div><i class="fa-solid fa-dna crate-icon"></i><div class="crate-label">VESSELS</div><div class="status-indicator">LOCKED</div></div>
            <div class="crate-card" id="c2"><div class="crate-header">MODEL 02</div><i class="fa-solid fa-eye crate-icon"></i><div class="crate-label">MACULA</div><div class="status-indicator">LOCKED</div></div>
            <div class="crate-card" id="c3"><div class="crate-header">MODEL 03</div><i class="fa-solid fa-braille crate-icon"></i><div class="crate-label">DRUSEN</div><div class="status-indicator">LOCKED</div></div>
            <div class="crate-card" id="c4"><div class="crate-header">MODEL 04</div><i class="fa-solid fa-wave-square crate-icon"></i><div class="crate-label">NERVES</div><div class="status-indicator">LOCKED</div></div>
            <div class="crate-card" id="c5"><div class="crate-header">MODEL 05</div><i class="fa-solid fa-droplet crate-icon"></i><div class="crate-label">BLEEDS</div><div class="status-indicator">LOCKED</div></div>
            <div class="crate-card" id="c6"><div class="crate-header">MODEL 06</div><i class="fa-solid fa-circle-nodes crate-icon"></i><div class="crate-label">SCAR</div><div class="status-indicator">LOCKED</div></div>
            <div class="crate-card" id="c7"><div class="crate-header">VERDICT</div><i class="fa-solid fa-shield-halved crate-icon"></i><div class="crate-label">RESULT</div><div class="status-indicator">PENDING</div></div>
        </div>

    </div>

    <script>
        // --- 3D ENGINE ---
        const PARTICLE_COUNT = 28000; 
        let scene, camera, renderer, composer, particles, geometry, material;
        let positions, targetPositions, alphas;
        let visibleCount = 0;
        let time = 0;
        let isProcessing = false; 

        init();
        animate();
        startGenesis();

        function init() {
            const container = document.getElementById('canvas-container');
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x020205, 0.02);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 30; camera.position.y = 0;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            container.appendChild(renderer.domElement);

            const renderScene = new THREE.RenderPass(scene, camera);
            const bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            bloomPass.strength = 0.4; bloomPass.radius = 0.3; bloomPass.threshold = 0.1;
            
            composer = new THREE.EffectComposer(renderer);
            composer.addPass(renderScene);
            composer.addPass(bloomPass);

            geometry = new THREE.BufferGeometry();
            positions = new Float32Array(PARTICLE_COUNT * 3);
            targetPositions = new Float32Array(PARTICLE_COUNT * 3);
            alphas = new Float32Array(PARTICLE_COUNT);
            const sizes = new Float32Array(PARTICLE_COUNT);

            const radius = 9; const tubeWidth = 3.5;
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                positions[i*3] = (Math.random() - 0.5) * 200;
                positions[i*3+1] = (Math.random() - 0.5) * 200;
                positions[i*3+2] = (Math.random() - 0.5) * 200;
                const u = Math.random() * Math.PI * 2; const v = (Math.random() * 2 - 1);
                targetPositions[i*3] = (radius + v * tubeWidth * Math.cos(u/2)) * Math.cos(u);
                targetPositions[i*3+1] = (radius + v * tubeWidth * Math.cos(u/2)) * Math.sin(u);
                targetPositions[i*3+2] = v * tubeWidth * Math.sin(u/2);
                alphas[i] = 0.0; sizes[i] = Math.random() * 0.8 + 0.2;
            }
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('alpha', new THREE.BufferAttribute(alphas, 1));
            geometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));

            material = new THREE.ShaderMaterial({
                uniforms: { color: { value: new THREE.Color(0xaaccff) }, uTime: { value: 0.0 }, uScanActive: { value: 0.0 } },
                vertexShader: `attribute float alpha; attribute float size; varying float vAlpha; varying float vY; void main() { vAlpha = alpha; vY = position.y; vec4 mv = modelViewMatrix * vec4(position, 1.0); gl_PointSize = size * (120.0 / -mv.z); gl_Position = projectionMatrix * mv; }`,
                fragmentShader: `uniform vec3 color; uniform float uTime; uniform float uScanActive; varying float vAlpha; varying float vY; void main() { float r = distance(gl_PointCoord, vec2(0.5)); if(r > 0.5) discard; float scanWave = 0.0; if(uScanActive > 0.5) { float wave = sin(vY * 0.8 - uTime * 8.0); scanWave = step(0.9, wave); } float blink = 1.0; if(uScanActive > 0.5) { blink = 0.8 + 0.2 * sin(uTime * 20.0); } float finalAlpha = (vAlpha * 0.5 + scanWave * 0.5) * blink; vec3 finalColor = mix(color, vec3(1.0), scanWave); gl_FragColor = vec4(finalColor, finalAlpha); }`,
                transparent: true, depthWrite: false, blending: THREE.AdditiveBlending
            });

            particles = new THREE.Points(geometry, material);
            particles.rotation.z = Math.PI / 6; particles.rotation.x = Math.PI / 4;
            scene.add(particles);

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
                composer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        // --- PHASE 1: GENESIS ---
        function startGenesis() {
            alphas[0] = 1.0; geometry.attributes.alpha.needsUpdate = true; visibleCount = 1;
            setTimeout(multiplyDots, 1000);
        }
        function multiplyDots() {
            if (visibleCount >= PARTICLE_COUNT) { setTimeout(attractToMobius, 500); return; }
            let growth = Math.ceil(visibleCount * 0.2) + 5;
            let nextLimit = Math.min(visibleCount + growth, PARTICLE_COUNT);
            for (let i = visibleCount; i < nextLimit; i++) alphas[i] = 1.0;
            visibleCount = nextLimit;
            geometry.attributes.alpha.needsUpdate = true;
            requestAnimationFrame(multiplyDots);
        }
        function attractToMobius() {
            const startPos = Float32Array.from(geometry.attributes.position.array);
            const obj = { t: 0 };
            anime({
                targets: obj, t: 1, duration: 4000, easing: 'easeInOutExpo',
                update: () => {
                    const curr = geometry.attributes.position.array;
                    for(let i=0; i<PARTICLE_COUNT; i++) {
                        const idx = i*3;
                        curr[idx] = startPos[idx] + (targetPositions[idx] - startPos[idx]) * obj.t;
                        curr[idx+1] = startPos[idx+1] + (targetPositions[idx+1] - startPos[idx+1]) * obj.t;
                        curr[idx+2] = startPos[idx+2] + (targetPositions[idx+2] - startPos[idx+2]) * obj.t;
                    }
                    geometry.attributes.position.needsUpdate = true;
                },
                complete: () => { revealLobby(); }
            });
        }

        function revealLobby() {
            anime({ targets: camera.position, y: -7, z: 28, duration: 2000, easing: 'easeInOutQuad' });
            anime({ targets: particles.rotation, x: Math.PI / 3, duration: 2000, easing: 'easeInOutQuad' });
            anime({ targets: '.lobby-ui', opacity: [0, 1], translateY: [50, 0], duration: 1000, delay: 500, easing: 'easeOutExpo' });
        }

        // --- PHASE 3: LOGS / ARMORY ---
        function openLogs() {
            // Hide Lobby
            anime({ targets: '.lobby-ui', opacity: 0, translateY: 50, duration: 500, easing: 'easeInExpo' });

            // Move 3D Object to Background (Side)
            anime({
                targets: camera.position,
                x: -15, y: 0, z: 20, // Pan camera Left
                duration: 1500, easing: 'easeInOutQuad'
            });
            anime({
                targets: particles.rotation,
                y: Math.PI / 2, // Rotate model
                duration: 1500, easing: 'easeInOutQuad'
            });

            // Show Logs Grid
            const logs = document.getElementById('logs');
            logs.style.opacity = 1; logs.style.pointerEvents = 'auto'; logs.style.transform = 'scale(1)';
        }

        function closeLogs() {
            // Hide Logs
            const logs = document.getElementById('logs');
            logs.style.opacity = 0; logs.style.pointerEvents = 'none'; logs.style.transform = 'scale(0.95)';

            // Return Camera to Center
            anime({
                targets: camera.position,
                x: 0, y: -7, z: 28,
                duration: 1500, easing: 'easeInOutQuad'
            });

            // Show Lobby
            anime({ targets: '.lobby-ui', opacity: 1, translateY: 0, duration: 1000, delay: 500, easing: 'easeOutExpo' });
        }


        // --- PHASE 4: PROCESSING ---
        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                // Hide Lobby
                anime({ targets: '.lobby-ui', opacity: 0, translateY: -50, duration: 500, easing: 'easeInExpo' });
                // Start Spin
                isProcessing = true; material.uniforms.uScanActive.value = 1.0; 
                anime({ targets: camera.position, y: 0, z: 24, duration: 1500, easing: 'easeInOutQuad' }); 
                anime({ targets: particles.rotation, x: Math.PI/4, z: 0, duration: 1500, easing: 'easeInOutQuad' });
                // Show Bar
                document.getElementById('processing').style.opacity = 1;
                anime({
                    targets: '#load-bar', width: '100%', duration: 3500, easing: 'linear',
                    complete: () => { finishProcessing(); }
                });
            }
        }

        function finishProcessing() {
            isProcessing = false; material.uniforms.uScanActive.value = 0.0;
            anime({ targets: '#processing', opacity: 0, duration: 300 });
            anime({ targets: camera.position, y: -6, z: 28, duration: 1500, easing: 'easeOutExpo' });

            const resultsUI = document.getElementById('results');
            resultsUI.style.opacity = 1; resultsUI.style.pointerEvents = 'auto';

            const crates = document.querySelectorAll('.crate-card');
            crates.forEach((crate, i) => {
                setTimeout(() => {
                    crate.classList.add('unlocked');
                    crate.querySelector('.status-indicator').innerText = "NORMAL"; 
                    if(i === 6) {
                         crate.querySelector('.status-indicator').innerText = "NEGATIVE";
                         crate.querySelector('.status-indicator').style.color = "#00ff88";
                    }
                }, i * 200);
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            time += 0.01; material.uniforms.uTime.value = time;
            if(particles) {
                if(isProcessing) particles.rotation.y += 0.08; 
                else particles.rotation.y += 0.002;
            }
            composer.render();
        }
    </script>
</body>
</html>
"""

with open('templates/phase2.html', 'w') as f:
    f.write(html_phase3_armory)

with open('backend.py', 'w') as f:
    f.write("""
import os
import sys
from flask import Flask, render_template

app = Flask(__name__, static_folder='static', template_folder='templates')

@app.route('/')
def phase2():
    return render_template('phase2.html')

if __name__ == '__main__':
    app.run(port=5000)
""")

print("âœ… PHASE 3 COMPLETE: ARMORY & NAVIGATION.")
print("- Click 'V500 LOGS' to swoop the camera and see the 7 models.")
print("- Hover over cards to see stats.")
print("- Click 'Return' to go back to the lobby.")